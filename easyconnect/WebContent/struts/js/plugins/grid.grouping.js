// Grouping module
(function(a){a.extend(a.jgrid,{template:function(d){var c=a.makeArray(arguments).slice(1),b=1;if(d===undefined){d=""}return d.replace(/\{([\w\-]+)(?:\:([\w\.]*)(?:\((.*?)?\))?)?\}/g,function(e,h){if(!isNaN(parseInt(h,10))){b++;return c[parseInt(h,10)]}else{var g=c[b],f=g.length;while(f--){if(h===g[f].nm){return g[f].v;break}}b++}})}});a.jgrid.extend({groupingSetup:function(){return this.each(function(){var g=this,c=g.p.groupingView;if(c!==null&&((typeof c==="object")||a.isFunction(c))){if(!c.groupField.length){g.p.grouping=false}else{if(typeof(c.visibiltyOnNextGrouping)==="undefined"){c.visibiltyOnNextGrouping=[]}c.lastvalues=[];c.groups=[];c.counters=[];for(var e=0;e<c.groupField.length;e++){if(!c.groupOrder[e]){c.groupOrder[e]="asc"}if(!c.groupText[e]){c.groupText[e]="{0}"}if(typeof(c.groupColumnShow[e])!=="boolean"){c.groupColumnShow[e]=true}if(typeof(c.groupSummary[e])!=="boolean"){c.groupSummary[e]=false}if(c.groupColumnShow[e]===true){c.visibiltyOnNextGrouping[e]=true;a(g).jqGrid("showCol",c.groupField[e])}else{c.visibiltyOnNextGrouping[e]=a("#"+a.jgrid.jqID(g.p.id+"_"+c.groupField[e])).is(":visible");a(g).jqGrid("hideCol",c.groupField[e])}}c.summary=[];var b=g.p.colModel;for(var d=0,f=b.length;d<f;d++){if(b[d].summaryType){c.summary.push({nm:b[d].name,st:b[d].summaryType,v:"",sr:b[d].summaryRound,srt:b[d].summaryRoundType||"round"})}}}}else{g.p.grouping=false}})},groupingPrepare:function(d,e,b,c){this.each(function(){var f=this.p.groupingView,m=this;var g=f.groupField.length,l,h,k=0;for(var j=0;j<g;j++){l=f.groupField[j];h=b[l];if(h!==undefined){if(c===0){f.groups.push({idx:j,dataIndex:l,value:h,startRow:c,cnt:1,summary:[]});f.lastvalues[j]=h;f.counters[j]={cnt:1,pos:f.groups.length-1,summary:a.extend(true,[],f.summary)};a.each(f.counters[j].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(m,this.v,this.nm,b)}else{this.v=a(m).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b)}});f.groups[f.counters[j].pos].summary=f.counters[j].summary}else{if((typeof(h)!=="object"&&(f.lastvalues[j]!==h))){f.groups.push({idx:j,dataIndex:l,value:h,startRow:c,cnt:1,summary:[]});f.lastvalues[j]=h;k=1;f.counters[j]={cnt:1,pos:f.groups.length-1,summary:a.extend(true,[],f.summary)};a.each(f.counters[j].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(m,this.v,this.nm,b)}else{this.v=a(m).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b)}});f.groups[f.counters[j].pos].summary=f.counters[j].summary}else{if(k===1){f.groups.push({idx:j,dataIndex:l,value:h,startRow:c,cnt:1,summary:[]});f.lastvalues[j]=h;f.counters[j]={cnt:1,pos:f.groups.length-1,summary:a.extend(true,[],f.summary)};a.each(f.counters[j].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(m,this.v,this.nm,b)}else{this.v=a(m).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b)}});f.groups[f.counters[j].pos].summary=f.counters[j].summary}else{f.counters[j].cnt+=1;f.groups[f.counters[j].pos].cnt=f.counters[j].cnt;a.each(f.counters[j].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(m,this.v,this.nm,b)}else{this.v=a(m).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b)}});f.groups[f.counters[j].pos].summary=f.counters[j].summary}}}}}e.push(d)});return e},groupingToggle:function(b){this.each(function(){var h=this,o=h.p.groupingView,d=b.split("_"),i=parseInt(d[d.length-2],10);d.splice(d.length-2,2);var l=d.join("_"),f=o.minusicon,k=o.plusicon,j=a("#"+a.jgrid.jqID(b)),c=j.length?j[0].nextSibling:null,m=a("#"+a.jgrid.jqID(b)+" span.tree-wrap-"+h.p.direction),g=false,n;if(m.hasClass(f)){if(o.showSummaryOnHide){if(c){while(c){if(a(c).hasClass("jqfoot")){var e=parseInt(a(c).attr("jqfootlevel"),10);if(e<=i){break}}a(c).hide();c=c.nextSibling}}}else{if(c){while(c){if(a(c).hasClass(l+"_"+String(i))||a(c).hasClass(l+"_"+String(i-1))){break}a(c).hide();c=c.nextSibling}}}m.removeClass(f).addClass(k);g=true}else{if(c){while(c){if(a(c).hasClass(l+"_"+String(i))||a(c).hasClass(l+"_"+String(i-1))){break}a(c).show();n=a(c).find("span.tree-wrap-"+h.p.direction);if(n&&a(n).hasClass(k)){a(n).removeClass(k).addClass(f)}c=c.nextSibling}}m.removeClass(k).addClass(f)}a(h).triggerHandler("jqGridGroupingClickGroup",[b,g]);if(a.isFunction(h.p.onClickGroup)){h.p.onClickGroup.call(h,b,g)}});return false},groupingRender:function(b,c){return this.each(function(){var f=this,o=f.p.groupingView,j="",k="",l,n,h=o.groupCollapse?o.plusicon:o.minusicon,d,i=[],p,g=o.groupField.length;h+=" tree-wrap-"+f.p.direction;p=0;a.each(f.p.colModel,function(r,t){for(var s=0;s<g;s++){if(o.groupField[s]===t.name){i[s]=r;break}}});var e=0;function q(t,u,r){if(u===0){return r[t]}else{var v=r[t].idx;if(v===0){return r[t]}for(var s=t;s>=0;s--){if(r[s].idx===v-u){return r[s]}}}}var m=a.makeArray(o.groupSummary);m.reverse();a.each(o.groups,function(w,t){e++;n=f.p.id+"ghead_"+t.idx;l=n+"_"+w;k="<span style='cursor:pointer;' class='ui-icon "+h+"' onclick=\"jQuery('#"+a.jgrid.jqID(f.p.id)+"').jqGrid('groupingToggle','"+l+"');return false;\"></span>";try{d=f.formatter(l,t.value,i[t.idx],t.value)}catch(H){d=t.value}j+='<tr id="'+l+'" role="row" class= "ui-widget-content jqgroup ui-row-'+f.p.direction+" "+n+'"><td style="padding-left:'+(t.idx*12)+'px;" colspan="'+c+'">'+k+a.jgrid.template(o.groupText[t.idx],d,t.cnt,t.summary)+"</td></tr>";var z=g-1===t.idx;if(z){var A=o.groups[w+1];var v=A!==undefined?o.groups[w+1].startRow:b.length;for(var s=t.startRow;s<v;s++){j+=b[s].join("")}var x;if(A!==undefined){for(x=0;x<o.groupField.length;x++){if(A.dataIndex===o.groupField[x]){break}}e=o.groupField.length-x}for(var E=0;E<e;E++){if(!m[E]){continue}var B="";if(o.groupCollapse&&!o.showSummaryOnHide){B=' style="display:none;"'}j+="<tr"+B+' jqfootlevel="'+(t.idx-E)+'" role="row" class="ui-widget-content jqfoot ui-row-'+f.p.direction+'">';var y=q(w,E,o.groups),D=f.p.colModel,C,F=y.cnt;for(var u=0;u<c;u++){var r="<td "+f.formatCol(u,1,"")+">&#160;</td>",G="{0}";a.each(y.summary,function(){if(this.nm===D[u].name){if(D[u].summaryTpl){G=D[u].summaryTpl}if(typeof(this.st)==="string"&&this.st.toLowerCase()==="avg"){if(this.v&&F>0){this.v=(this.v/F)}}try{C=f.formatter("",this.v,u,this)}catch(I){C=this.v}r="<td "+f.formatCol(u,1,"")+">"+a.jgrid.format(G,C)+"</td>";return false}});j+=r}j+="</tr>"}e=x}});a("#"+a.jgrid.jqID(f.p.id)+" tbody:first").append(j);j=null})},groupingGroupBy:function(c,b){return this.each(function(){var f=this;if(typeof(c)==="string"){c=[c]}var d=f.p.groupingView;f.p.grouping=true;if(typeof d.visibiltyOnNextGrouping==="undefined"){d.visibiltyOnNextGrouping=[]}var e;for(e=0;e<d.groupField.length;e++){if(!d.groupColumnShow[e]&&d.visibiltyOnNextGrouping[e]){a(f).jqGrid("showCol",d.groupField[e])}}for(e=0;e<c.length;e++){d.visibiltyOnNextGrouping[e]=a("#"+a.jgrid.jqID(f.p.id)+"_"+a.jgrid.jqID(c[e])).is(":visible")}f.p.groupingView=a.extend(f.p.groupingView,b||{});d.groupField=c;a(f).trigger("reloadGrid")})},groupingRemove:function(b){return this.each(function(){var e=this;if(typeof(b)==="undefined"){b=true}e.p.grouping=false;if(b===true){var c=e.p.groupingView;for(var d=0;d<c.groupField.length;d++){if(!c.groupColumnShow[d]&&c.visibiltyOnNextGrouping[d]){a(e).jqGrid("showCol",c.groupField)}}a("tr.jqgroup, tr.jqfoot","#"+a.jgrid.jqID(e.p.id)+" tbody:first").remove();a("tr.jqgrow:hidden","#"+a.jgrid.jqID(e.p.id)+" tbody:first").show()}else{a(e).trigger("reloadGrid")}})},groupingCalculations:{handler:function(f,i,g,j,h,b){var c={sum:function(){return parseFloat(i||0)+parseFloat((b[g]||0))},min:function(){if(i===""){return parseFloat(b[g]||0)}return Math.min(parseFloat(i),parseFloat(b[g]||0))},max:function(){if(i===""){return parseFloat(b[g]||0)}return Math.max(parseFloat(i),parseFloat(b[g]||0))},count:function(){if(i===""){i=0}if(b.hasOwnProperty(g)){return i+1}else{return 0}},avg:function(){return c.sum()}};if(!c[f]){throw ("jqGrid Grouping No such method: "+f)}var e=c[f]();if(j!=null){if(h=="fixed"){e=e.toFixed(j)}else{var d=Math.pow(10,j);e=Math.round(e*d)/d}}return e}}})})(jQuery);